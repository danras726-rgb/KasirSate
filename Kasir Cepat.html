<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <title>Kasir Cerdas Cak Sabar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--muted:#64748b;--accent:#0891b2;--bg:#f1f5f9;--card:#ffffff;--red:#ef4444}
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,sans-serif}
    body{margin:0;background:var(--bg);color:#0f172a;padding:12px;padding-bottom:80px}
    .app{max-width:600px;margin:0 auto}
    
    /* Header & Stats */
    header{margin-bottom:16px}
    h1{font-size:20px;margin:0;color:var(--accent)}
    .sub{font-size:12px;color:var(--muted)}
    
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
    .stat-card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
    .stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .stat-val{font-size:16px;font-weight:700;margin-top:2px}

    /* AI Input Section */
    .ai-section{background:#fff;padding:16px;border-radius:16px;border:1px solid #cffafe;box-shadow:0 4px 6px -1px rgba(8,145,178,0.1);margin-bottom:16px}
    .ai-box{width:100%;border:2px solid #e2e8f0;border-radius:10px;padding:12px;font-size:14px;margin-top:8px;transition:0.2s;resize:none}
    .ai-box:focus{border-color:var(--accent);outline:none}
    .ai-hint{font-size:11px;color:var(--muted);margin-top:8px;line-height: 1.5; background: #f8fafc; padding: 8px; border-radius: 6px; border: 1px dashed #cbd5e1;}
    
    /* Menu Grid */
    .section-title{font-weight:700;margin:16px 0 8px;display:flex;justify-content:space-between;align-items:center}
    .menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .menu-item{background:var(--card);border:1px solid #e2e8f0;border-radius:12px;padding:12px;cursor:pointer;position:relative;transition:0.1s; user-select: none;} 
    .menu-item:active{transform:scale(0.98);background:#f8fafc}
    .m-name{font-weight:600;font-size:14px;line-height:1.2}
    .m-price{font-size:12px;color:var(--accent);font-weight:600;margin-top:4px}
    
    /* Badges */
    .badge{position:absolute;top:-6px;right:-6px;background:var(--red);color:white;font-size:10px;font-weight:bold;min-width:20px;height:20px;border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(239,68,68,0.3)}

    /* Cart & Controls */
    .cart-wrapper{background:var(--card);border-radius:16px;padding:16px;margin-top:20px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.05)}
    .cart-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #e2e8f0;font-size:14px}
    .cart-row:last-child{border-bottom:none}
    .c-name{flex:1}
    .c-qty{color:var(--muted);margin-right:8px}
    .c-price{font-weight:600}
    
    .btn{width:100%;padding:12px;border:none;border-radius:10px;background:var(--accent);color:white;font-weight:600;font-size:14px;cursor:pointer;margin-top:8px}
    .btn.secondary{background:#e2e8f0;color:#334155}
    .btn.danger{background:#fee2e2;color:#991b1b}

    /* Modal */
    #modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(2px)}
    .modal-card{background:white;width:90%;max-width:340px;padding:20px;border-radius:16px;animation:pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
    @keyframes pop{from{transform:scale(0.9)}to{transform:scale(1)}}
    
    .total-display{font-size:24px;font-weight:800;text-align:center;margin:10px 0;color:var(--accent)}
    input.money{width:100%;padding:12px;font-size:18px;text-align:center;border:2px solid #e2e8f0;border-radius:10px;margin-bottom:10px}
    
    /* Tables */
    table{width:100%;border-collapse:collapse;font-size:12px}
    th{text-align:left;color:var(--muted);padding:4px}
    td{padding:6px 4px;border-bottom:1px solid #f1f5f9}
  </style>
</head>
<body>

<div class="app">
  <header>
    <h1>Warung Cak Sabar</h1>
    <div class="sub">Kasir Cerdas & Pencatat Keuangan</div>
  </header>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Omset Hari Ini</div>
      <div class="stat-val" id="omsetVal">Rp 0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Transaksi</div>
      <div class="stat-val" id="trxVal">0</div>
    </div>
  </div>

  <div class="ai-section">
    <div style="font-weight:600;color:var(--accent)">⚡ Pesan Cepat (AI)</div>
    <textarea id="aiInput" class="ai-box" rows="2" placeholder="Contoh: A 5, G 10rb, es teh 2"></textarea>
    <div class="ai-hint">
        <strong>Kode Cepat:</strong><br>
        <b>A</b> = Sate Ayam, <b>K</b> = Sate Kambing, <b>KT</b> = Kambing Tanpa Lemak, <b>G</b> = Gule.<br>
        <span style="color:var(--accent)">Tips: Ketik "10rb" untuk otomatis jadi 10.000</span>
    </div>
    <button class="btn" style="margin-top:8px;padding:8px" onclick="parseAI()">Masukan ke Keranjang</button>
  </div>

  <div class="section-title">Makanan</div>
  <div class="menu-grid" id="foodGrid"></div>

  <div class="section-title">Minuman & Lainnya</div>
  <div class="menu-grid" id="drinkGrid"></div>

  <div class="cart-wrapper">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span style="font-weight:700">Keranjang Belanja</span>
      <button onclick="resetCart()" style="background:none;border:none;color:var(--red);font-size:12px;cursor:pointer">Kosongkan</button>
    </div>
    <div id="cartList"><div style="text-align:center;color:var(--muted);font-size:12px;padding:10px">Belum ada item</div></div>
    <div style="margin-top:12px;border-top:2px solid #f1f5f9;padding-top:12px;display:flex;justify-content:space-between;font-weight:700">
      <span>Total</span>
      <span id="cartTotal">Rp 0</span>
    </div>
    <button class="btn" onclick="showCheckout()">Bayar / Checkout</button>
  </div>

  <div style="margin-top:30px">
    <div class="section-title">
      Riwayat Transaksi
      <button onclick="exportExcel()" style="font-size:11px;padding:4px 8px;border-radius:6px;border:1px solid #cbd5e1;background:#fff">Export Excel</button>
    </div>
    <div style="background:#fff;border-radius:12px;padding:12px;overflow:hidden">
      <table id="historyTable"></table>
    </div>
  </div>
</div>

<div id="modal">
  <div class="modal-card">
    <h3 style="margin:0 0 10px;text-align:center">Pembayaran</h3>
    <div class="total-display" id="modalTotal">Rp 0</div>
    
    <label style="font-size:12px;color:var(--muted)">Uang Diterima</label>
    <input type="number" id="paidInput" class="money" placeholder="0">
    
    <div style="display:flex;justify-content:space-between;margin-bottom:16px;font-weight:600">
      <span>Kembalian:</span>
      <span id="changeDisplay">Rp 0</span>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="btn secondary" onclick="closeModal()">Batal</button>
      <button class="btn" onclick="processTransaction()">Selesai</button>
    </div>
  </div>
</div>

<script>
/**
 * DATA MENU & KONFIGURASI HARGA
 */
const DATA_MENU = [
  // SATE KAMBING
  { id: 'sk_tusuk', keywords: ['sate kambing', 'kambing'], label: 'Sate Kambing (Tusuk)', price: 2400, category: 'food', visible: false },
  // UPDATE: Ditambahkan keyword 'k'
  { id: 'sk_porsi', keywords: ['sate kambing porsi', 'k'], label: 'Sate Kambing (Porsi)', price: 24000, category: 'food', visible: true },
  
  // SATE KAMBING POLOS
  { id: 'sk_nl_tusuk', keywords: ['kambing tanpa lemak', 'no lemak', 'sk polos'], label: 'Sate Kambing TL (Tusuk)', price: 2600, category: 'food', visible: false },
  // UPDATE: Ditambahkan keyword 'kt'
  { id: 'sk_nl_porsi', keywords: ['kambing tanpa lemak porsi', 'kt'], label: 'Sate Kambing TL (Porsi)', price: 26000, category: 'food', visible: true },

  // SATE AYAM
  { id: 'sa_tusuk', keywords: ['sate ayam', 'ayam'], label: 'Sate Ayam (Tusuk)', price: 1200, category: 'food', visible: false },
  // UPDATE: Ditambahkan keyword 'a'
  { id: 'sa_porsi', keywords: ['sate ayam porsi', 'a'], label: 'Sate Ayam (Porsi)', price: 12000, category: 'food', visible: true },

  // GULE
  // UPDATE: Ditambahkan keyword 'g'
  { id: 'gule', keywords: ['gule', 'gulai', 'g'], label: 'Gule (Porsi)', price: 24000, category: 'food', visible: true, isFlexible: true },
  
  // MAKANAN LAIN
  { id: 'nasi_gule', keywords: ['nasi gule', 'nasi gulai'], label: 'Nasi Gule', price: 14000, category: 'food', visible: true },
  { id: 'nasi', keywords: ['nasi', 'sego'], label: 'Nasi Putih', price: 3000, category: 'food', visible: true },
  { id: 'kerupuk', keywords: ['kerupuk', 'rupuk'], label: 'Kerupuk', price: 1000, category: 'food', visible: true },

  // MINUMAN
  { id: 'es_teh', keywords: ['es teh'], label: 'Es Teh', price: 3000, category: 'drink', visible: true },
  { id: 'es_jeruk', keywords: ['es jeruk'], label: 'Es Jeruk', price: 3000, category: 'drink', visible: true },
  { id: 'teh_anget', keywords: ['teh anget', 'teh hangat'], label: 'Teh Anget', price: 3000, category: 'drink', visible: true },
  { id: 'jeruk_anget', keywords: ['jeruk anget', 'jeruk hangat'], label: 'Jeruk Anget', price: 3000, category: 'drink', visible: true }
];

let cart = [];
let transactions = JSON.parse(localStorage.getItem('trx_cak_sabar') || '[]');
const formatRp = n => 'Rp ' + Number(n).toLocaleString('id-ID');

/* ================= INIT ================= */
function init() {
  renderMenuGrid();
  updateStats();
  renderHistory();
}

/* ================= RENDER MENU GRID ================= */
function renderMenuGrid() {
  const foodContainer = document.getElementById('foodGrid');
  const drinkContainer = document.getElementById('drinkGrid');

  DATA_MENU.forEach(item => {
    if (!item.visible) return;

    const el = document.createElement('div');
    el.className = 'menu-item';
    el.onclick = () => addToCart(item);
    el.innerHTML = `
      <div class="m-name">${item.label}</div>
      <div class="m-price">${formatRp(item.price)}</div>
      <div class="badge" id="badge_${item.id}" style="display:none">0</div>
    `;

    if (item.category === 'food') foodContainer.appendChild(el);
    else drinkContainer.appendChild(el);
  });
}

/* ================= CART LOGIC ================= */
function addToCart(item, qty = 1, customPrice = null) {
  // Cek apakah item sudah ada di keranjang dengan harga yang sama
  const existing = cart.find(c => c.id === item.id && c.price === (customPrice || item.price));
  
  if (existing) {
    existing.qty += qty;
  } else {
    cart.push({
      id: item.id,
      label: item.label,
      price: customPrice || item.price,
      qty: qty
    });
  }
  renderCart();
}

function renderCart() {
  const container = document.getElementById('cartList');
  container.innerHTML = '';
  let total = 0;

  // Reset semua badge ke 0 dan hide dulu
  document.querySelectorAll('.badge').forEach(b => {
    b.style.display = 'none';
    b.textContent = '0';
  });

  if (cart.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--muted);font-size:12px;padding:10px">Keranjang Kosong</div>';
  } else {
    cart.forEach((c, idx) => {
      total += c.price * c.qty;
      
      // Update badge di menu grid jika ada
      const badge = document.getElementById(`badge_${c.id}`);
      if (badge) {
        badge.style.display = 'flex';
        const currentVal = parseInt(badge.textContent) || 0;
        badge.textContent = currentVal + c.qty;
      }

      const row = document.createElement('div');
      row.className = 'cart-row';
      row.innerHTML = `
        <div class="c-name">${c.label} <small style="color:#64748b">(@${c.price})</small></div>
        <div class="c-qty">x${c.qty}</div>
        <div class="c-price">${formatRp(c.price * c.qty)}</div>
        <button onclick="removeItem(${idx})" style="margin-left:8px;border:none;background:none;color:red;font-weight:bold">×</button>
      `;
      container.appendChild(row);
    });
  }
  document.getElementById('cartTotal').textContent = formatRp(total);
}

function removeItem(idx) {
  cart.splice(idx, 1);
  renderCart();
}

function resetCart() {
  cart = [];
  renderCart(); 
  document.getElementById('aiInput').value = '';
}

/* ================= AI PARSER LOGIC UPDATED ================= */
function parseAI() {
  let text = document.getElementById('aiInput').value.toLowerCase();
  if (!text.trim()) return;

  // 1. UPDATE: Replace "rb" dengan "000" secara cerdas
  // Contoh: "10rb" menjadi "10000", "5 rb" menjadi "5000"
  text = text.replace(/(\d+)\s*rb\b/gi, '$1000'); 

  const orders = text.split(/[\n,]+/);

  orders.forEach(raw => {
    const line = raw.trim();
    if (!line) return;

    let numbers = line.match(/\d+(\.\d+)?/g); 
    let numericValues = numbers ? numbers.map(n => parseInt(n.replace(/\./g, ''))) : [1];
    
    let qty = 1;
    let customPrice = null;

    numericValues.forEach(val => {
      if (val > 500) customPrice = val;
      else qty = val;
    });

    let bestMatch = null;
    let maxScore = 0; // Score based on keyword length

    DATA_MENU.forEach(item => {
      item.keywords.forEach(key => {
        // UPDATE: Gunakan Regex dengan Word Boundary (\b)
        // Agar huruf "a" tidak cocok dengan "nasi", tapi cocok dengan "a 5" atau "5 a"
        const regex = new RegExp(`\\b${key}\\b`, 'i');
        
        if (regex.test(line)) {
          // Prioritaskan keyword yang lebih spesifik/panjang
          if (key.length >= maxScore) {
            maxScore = key.length;
            bestMatch = item;
          }
        }
      });
    });

    if (bestMatch) {
      if (customPrice && bestMatch.isFlexible) {
        addToCart(bestMatch, 1, customPrice); 
      } 
      else if (customPrice && !bestMatch.isFlexible) {
         let calculatedQty = Math.floor(customPrice / bestMatch.price);
         if(calculatedQty > 0) addToCart(bestMatch, calculatedQty);
      }
      else {
        addToCart(bestMatch, qty);
      }
    }
  });

  document.getElementById('aiInput').value = '';
}

/* ================= CHECKOUT & TRANSACTION ================= */
function showCheckout() {
  if (cart.length === 0) return alert('Keranjang kosong');
  const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
  
  document.getElementById('modalTotal').textContent = formatRp(total);
  document.getElementById('paidInput').value = '';
  document.getElementById('changeDisplay').textContent = 'Rp 0';
  document.getElementById('modal').style.display = 'flex';
  
  document.getElementById('paidInput').oninput = (e) => {
    const paid = parseInt(e.target.value) || 0;
    const change = paid - total;
    document.getElementById('changeDisplay').textContent = formatRp(change);
    document.getElementById('changeDisplay').style.color = change < 0 ? 'red' : 'green';
  };
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function processTransaction() {
  const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
  const paid = parseInt(document.getElementById('paidInput').value) || 0;
  
  if (paid < total && paid !== 0) {
    if(!confirm('Uang kurang! Tetap lanjutkan sebagai utang/kurang bayar?')) return;
  }

  const trx = {
    id: Date.now(),
    date: new Date().toLocaleString('id-ID'),
    items: [...cart],
    total: total,
    paid: paid
  };

  transactions.unshift(trx);
  localStorage.setItem('trx_cak_sabar', JSON.stringify(transactions));
  
  resetCart();
  closeModal();
  updateStats();
  renderHistory();
  alert('Transaksi Berhasil!');
}

/* ================= HISTORY & STATS ================= */
function updateStats() {
  const today = new Date().toLocaleDateString('id-ID');
  const todaysTrx = transactions.filter(t => t.date.includes(today)); 
  
  const omset = todaysTrx.reduce((a, b) => a + b.total, 0);
  
  document.getElementById('omsetVal').textContent = formatRp(omset);
  document.getElementById('trxVal').textContent = todaysTrx.length;
}

function renderHistory() {
  const table = document.getElementById('historyTable');
  table.innerHTML = `<tr><th>Waktu</th><th>Detail</th><th style="text-align:right">Total</th></tr>`;
  
  transactions.slice(0, 10).forEach(t => {
    const itemsStr = t.items.map(i => `${i.label} x${i.qty}`).join(', ');
    const row = `
      <tr>
        <td style="white-space:nowrap;color:#64748b;font-size:10px">${t.date.split(',')[1] || t.date}</td>
        <td>${itemsStr}</td>
        <td style="text-align:right;font-weight:600">${formatRp(t.total)}</td>
      </tr>
    `;
    table.innerHTML += row;
  });
}

function exportExcel() {
  const data = transactions.map(t => ({
    Tanggal: t.date,
    Total: t.total,
    Bayar: t.paid,
    Item: t.items.map(i => `${i.label} (${i.qty})`).join('; ')
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Transaksi");
  XLSX.writeFile(wb, "Laporan_Warung_CakSabar.xlsx");
}

init();
</script>
</body>
</html>
